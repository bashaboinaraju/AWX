- name: Get Disk Space Information
  win_shell: |
    Get-WmiObject Win32_LogicalDisk | 
    Select-Object DeviceID, @{Name="Size";Expression={$_.Size}}, @{Name="FreeSpace";Expression={$_.FreeSpace}} | 
    ConvertTo-Json
  register: disk_space
  ignore_errors: yes

- name: Display Formatted Results
  debug:
    msg: |
      üíæ Disk Space:
      {% if disk_space.stdout is defined %}
        {% set disk_data = disk_space.stdout | from_json %}
        {% for disk in disk_data %}
          - Volume: {{ disk.DeviceID }} | Size: {{ (disk.Size | int / 1073741824) | round(2) }} GB | Free: {{ (disk.FreeSpace | int / 1073741824) | round(2) }} GB ({{ ((disk.FreeSpace | float / disk.Size | float) * 100) | round(2) }}%)
        {% else %}
          - No valid disk space data available.
        {% endfor %}
      {% else %}
        - No disk space data available.
      {% endif %}

      üìä Database Space Utilization:
      {% for item in db_space_fact | default([]) if item.DatabaseName is defined and item.SizeMB is defined %}
       - {{ item.DatabaseName }}: {{ item.SizeMB }} MB
      {% endfor %}
      üö® Deadlocks:
      {% if (deadlocks_fact.Deadlocks | default(0) | int) > 0 %}
       - {{ deadlocks_fact.Deadlocks }} deadlocks detected!
      {% else %}
       - No deadlocks detected
      {% endif %}
      [‚ÑπÔ∏è] Job activities query returned {{ job_activities_fact | default([]) | length }} rows.
      üõ† SQL Server Agent Job Activities:
      {% if job_activities_fact.name is defined and job_activities_fact.enabled is defined and job_activities_fact.last_run_status is defined %}
       - Job: {{ job_activities_fact.name }} | Enabled: {{ job_activities_fact.enabled }} | Last Outcome: 
         {% if job_activities_fact.last_run_status | default(-1) == 1 %}
           Succeeded
         {% elif job_activities_fact.last_run_status | default(-1) == 0 %}
           Failed
         {% elif job_activities_fact.last_run_status | default(-1) == 2 %}
           Retry
         {% elif job_activities_fact.last_run_status | default(-1) == 3 %}
           Canceled
         {% else %}
           Unknown
         {% endif %}
      {% else %}
        [‚ùå] No job activities found or missing required fields.
      {% endif %}
      ü©∫ Database Health Check:
      {% if db_health_fact is defined and db_health_fact | length > 0 %}
        {% for item in db_health_fact | default([]) %}
           - Database: {{ item.DatabaseName | default([]) }}
             - Status: {{ item.Status | default([]) }}
             - Active Requests: {{ item.ActiveRequests | default(0) }}
             - Active User Connections: {{ item.ActiveUserConnections | default(0) }}
             - Pending Requests: {{ item.PendingRequests | default(0) }}
             - CPU Queue Length: {{ item.CPUQueueLength | default(0) }}
        {% endfor %}
      {% else %}
        [‚ùå] No database health data available.
      {% endif %}
      
      üìú SQL Server Error Log:
      {% if error_logs_fact is defined and error_logs_fact | length > 0 %}
        {% for item in error_logs_fact | default([]) %}
          - Date: {{ item.logdate | default('Unknown') }}
            - Process: {{ item.processinfo | default('Unknown') }}
            - Message: {{ item.text | default('No message') | truncate(100) }}
        {% endfor %}
      {% else %}
        [‚ÑπÔ∏è] No errors found in SQL Server logs or error log data not available.
      {% endif %}
